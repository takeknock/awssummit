# JapanTaxi
## 講演者
- 梅田さん(@ebisusurf)
## タクシーの会社

## 全国卓志ー
- タクシー会社が内製
- 位置情報サービス
    - 利用者が住所のないところから利用

## そのほかのサービス
- パートナー向けサービス(連携する場合、APIの準備が必要)
- 乗務員の型向けアプリ
- 運行管理(そもそも今車がどこを走っているかといった情報の管理。法律要件)

## サービスの歴史
- 2011年ローンチ
- 2016年リニューアル
- もともとベンダーにてかっちり作られたアプリだった。内製への転換

# JapanTaxi構成
## 環境
- Dev, Stage, Prod
## 構成
- ElasticBeanStalk
- 非同期のため、SQS

- fluentdにすべてログ転送

# Athena
- 雑に使えるpresto(BigQueryみたいなもの?)
- 課金対象がスキャン量のみ(転送量を気にせず利用可能)
- S3がそのままデータソース
- S3においてあるものをそのまま使える(ほかのデータウェアハウスDWH使用すると、データをロードするところを作る必要があるが、これならそのまま使える)

## 大きなメリット
- S3の資産そのまま使える
## EMRとの差
    - Athenaはマネージドなpresto
    - 前後処理がしたい、ストリーム処理がしたいならEMR一択
- ゼロベースならAthenaを利用
- EMRはAthenaでできないことをする

## ログの基盤開発
- 一人でやってるときに重要なこと
    - 早い→可用性、ノウハウあり
    - 安い→ログを使ういｎあたって、これが正しいですよ、というのは難しい。
    - うまい→ログがたまってきたときにスケールしないのはだめだよね
## とにかく集める
- 散らばってるログをS3に集約
- Windows, SQLServer, Linux
- FileStorage(5年分)

## S3がよかったこと
- Embulkといった安心のOSSのETLツール
- 安心のAWS内包

### S3の設定がAthenaを意識されてなくても問題ない

# 詳細
## ログの集め方
- nginx, Rails, .NET(カラムがありませんといったエラーに悩まされた)(fluentd)→S3
- MySQL, SQLServer(embulk(bulk importを開けてる), digdag)→S3
## データ量
- probe 1.5G/daily + app log
- 1年分スキャンしても問題なし。

## UIとしてのre:dash
- WebベースのBIツール
- バックエンドにMySQL等を使って、
- tablo、dashbiもあるが、re:dashはブラウザさえあれば見れる。

## Athenaとre:dash
- iamを発行(keyとsecretをre:dashに渡す)
- 本来的にはdatadogとかでやるが、インフラの知見が必要。
- 状態監視(alertサポート)
- S3にはクレンジングしたデータだけ投げて、re:dashでS3のきれいなデータを誰でも見れるようにする。

## サービスの処理フロー
### 予約注文
- re:dashとathenaでリアルタイム監視
- 予約を受けたけど、受領できなかった注文が発生した時間と場所を登録

### 通常予約と定額枠
- 使うたくしーは同じなのに、別枠になってた
- 枠の統一→注文ロスの排除

### 時系列データを可視化する
- httpのアクセス数とかとたくしー
- streamで注文びーくタイムの計測
- not アクセス数(お０とスケールしても車は増えない)
- 天候と

#### datadog入れる前、merkerelで監視してた
- 風雨すごい+忘年会シーsズン
- 爆アクセス

### メリット
- いろんな人への情報共有として使える

#### SDK, API公開済み
